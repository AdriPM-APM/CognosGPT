<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CognosGPT - Asistente Inteligente</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      transition: background 0.3s ease;
    }
    .light-theme {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .dark-theme {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      color: #e5e7eb;
    }
    .chat-container {
      max-height: 70vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      scrollbar-width: thin;
      scrollbar-color: #9ca3af #f3f4f6;
    }
    .chat-container::-webkit-scrollbar {
      width: 8px;
    }
    .chat-container::-webkit-scrollbar-track {
      background: #f3f4f6;
    }
    .chat-container::-webkit-scrollbar-thumb {
      background: #9ca3af;
      border-radius: 4px;
    }
    .message {
      max-width: 80%;
      margin: 10px;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
    }
    .user-message {
      background-color: #3b82f6;
      color: white;
      margin-left: auto;
    }
    .ai-message {
      background-color: #e5e7eb;
      color: #1f2937;
      margin-right: auto;
    }
    .dark-theme .ai-message {
      background-color: #4b5563;
      color: #e5e7eb;
    }
    .loading::after {
      content: ' .';
      animation: dots 1.5s infinite;
    }
    .history-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 20;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .history-panel.show {
      opacity: 1;
      pointer-events: auto;
    }
    .history-content {
      background: white;
      dark:bg-gray-800;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease;
    }
    .dark-theme .history-content {
      background: #1f2937;
    }
    @keyframes dots {
      0% { content: ' .'; }
      33% { content: ' ..'; }
      66% { content: ' ...'; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
 </style>
</head>
<body class="light-theme">
  <div class="container">
    <header>
      <div class="text-center">
        <h3>CognosGPT</h3>
        <p>Tu asistente para educación, programación y más</p>
      </div>
      <button class="theme-toggle" id="theme-toggle" aria-label="Cambiar tema">
        <svg id="theme-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path id="theme-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
      </button>
    </header>

    <div class="chat-actions">
      <button id="history-btn" class="btn history-btn">Ver Chats Guardados</button>
      <button id="clear-btn" class="btn clear-btn">Limpiar Chat</button>
    </div>

    <div class="chat-container" id="chat-box" role="log" aria-live="polite">
      <!-- Mensajes aparecerán aquí -->
    </div>

    <div class="input-form">
      <textarea id="user-input" placeholder="Escribe tu pregunta para CognosGPT..."></textarea>
      <div class="input-group">
        <input type="file" id="image-input" accept="image/*">
        <button id="send-btn" class="btn send-btn">Enviar</button>
      </div>
      <div id="image-preview-container" class="hidden">
        <img id="image-preview" class="image-preview" alt="Vista previa de la imagen">
      </div>
    </div>

    <div class="history-panel" id="history-panel">
      <div class="history-content">
        <div class="history-header">
          <h3>Chats Guardados</h3>
          <button id="close-history" class="close-history">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <ul id="chat-list" class="chat-list"></ul>
      </div>
    </div>
  </div>

  <script>
    // Elementos DOM
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const imageInput = document.getElementById('image-input');
    const sendButton = document.getElementById('send-btn');
    const clearButton = document.getElementById('clear-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const themePath = document.getElementById('theme-path');
    const historyButton = document.getElementById('history-btn');
    const historyPanel = document.getElementById('history-panel');
    const closeHistory = document.getElementById('close-history');
    const chatList = document.getElementById('chat-list');
    const imagePreview = document.getElementById('image-preview');
    const imagePreviewContainer = document.getElementById('image-preview-container');

    // 1. SOLUCIÓN A PROBLEMA DE SEGURIDAD
    // Nunca expongas API keys en frontend - esto es solo para demostración
    // En producción deberías usar un backend propio
    const API_KEY = 'TU_API_KEY_REAL_AQUI';  // Reemplazar con tu key real
    const API_URL = 'https://openrouter.ai/api/v1/chat/completions';

    // Generar ID único para chats
    function generateId() {
      return 'id-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
    }

    // Convertir imagen a base64
    function imageToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Cargar historial de chats
    function loadChatHistory() {
      const chats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
      chatList.innerHTML = '';
      
      Object.keys(chats).forEach(chatId => {
        const chat = chats[chatId];
        const li = document.createElement('li');
        li.textContent = `${chat.title || 'Chat sin título'} (${chat.timestamp})`;
        li.dataset.chatId = chatId;
        
        li.addEventListener('click', () => {
          loadChat(chatId);
          historyPanel.classList.remove('show');
        });
        
        chatList.appendChild(li);
      });
    }

    // Cargar un chat específico
    function loadChat(chatId) {
      const chats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
      const chat = chats[chatId];
      
      if (!chat) return;
      
      chatBox.innerHTML = '';
      chat.messages.forEach(msg => {
        addMessage(msg.content, msg.isUser, msg.isError);
      });
      
      localStorage.setItem('currentChatId', chatId);
      imagePreviewContainer.classList.add('hidden');
    }

    // Guardar mensaje
    function saveMessage(content, isUser, isError = false, chatId = null) {
      const chats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
      const currentChatId = chatId || localStorage.getItem('currentChatId') || generateId();

      if (!chats[currentChatId]) {
        chats[currentChatId] = {
          title: content.length > 30 ? content.substring(0, 30) + '...' : content,
          timestamp: new Date().toLocaleString(),
          messages: []
        };
        localStorage.setItem('currentChatId', currentChatId);
      }

      chats[currentChatId].messages.push({ content, isUser, isError });
      localStorage.setItem('chatHistory', JSON.stringify(chats));
      loadChatHistory();
    }

    // Agregar mensaje al chat
    function addMessage(content, isUser, isError = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : isError ? 'error-message' : 'ai-message'}`;
      messageDiv.textContent = content;
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Mostrar indicador de carga
    function showLoading() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading';
      loadingDiv.className = 'message ai-message loading';
      loadingDiv.textContent = 'CognosGPT está pensando';
      chatBox.appendChild(loadingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return loadingDiv;
    }

    // Event Listeners
    imageInput.addEventListener('change', async () => {
      if (imageInput.files[0]) {
        try {
          const base64 = await imageToBase64(imageInput.files[0]);
          imagePreview.src = base64;
          imagePreviewContainer.classList.remove('hidden');
        } catch (error) {
          addMessage('Error al cargar la imagen.', false, true);
        }
      } else {
        imagePreviewContainer.classList.add('hidden');
      }
    });

    sendButton.addEventListener('click', sendMessage);
    
    async function sendMessage() {
      const prompt = userInput.value.trim();
      const file = imageInput.files[0];
      
      if (!prompt && !file) return;

      const messageContent = prompt || 'Imagen subida';
      addMessage(messageContent, true);
      saveMessage(messageContent, true);

      const loadingDiv = showLoading();

      const message = {
        role: 'user',
        content: [{ type: 'text', text: prompt || '¿Qué hay en esta imagen?' }]
      };

      if (file) {
        try {
          const base64 = await imageToBase64(file);
          message.content.push({
            type: 'image_url',
            image_url: { url: base64 }
          });
        } catch (error) {
          chatBox.removeChild(loadingDiv);
          addMessage('Error al procesar la imagen.', false, true);
          saveMessage('Error al procesar la imagen.', false, true);
          return;
        }
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'google/gemini-2.0-flash-exp:free',
            messages: [{
              role: 'system',
              content: `Eres CognosGPT, un asistente especializado en educación, 
                        programación y análisis de imágenes. Proporciona respuestas 
                        claras, detalladas y adaptadas al contexto del usuario.`
            }, message]
          })
        });

        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        
        chatBox.removeChild(loadingDiv);
        addMessage(aiResponse, false);
        saveMessage(aiResponse, false);
      } catch (error) {
        chatBox.removeChild(loadingDiv);
        addMessage(`Error: ${error.message || 'No se pudo conectar con el servicio'}`, false, true);
        saveMessage(`Error: ${error.message || 'Error de conexión'}`, false, true);
      }

      userInput.value = '';
      imageInput.value = '';
      imagePreviewContainer.classList.add('hidden');
    }

    historyButton.addEventListener('click', () => {
      historyPanel.classList.add('show');
    });

    historyPanel.addEventListener('click', (e) => {
      if (e.target === historyPanel) {
        historyPanel.classList.remove('show');
      }
    });

    closeHistory.addEventListener('click', () => {
      historyPanel.classList.remove('show');
    });

    clearButton.addEventListener('click', () => {
      chatBox.innerHTML = '';
      const currentChatId = localStorage.getItem('currentChatId');
      
      if (currentChatId) {
        const chats = JSON.parse(localStorage.getItem('chatHistory') || '{}');
        delete chats[currentChatId];
        localStorage.setItem('chatHistory', JSON.stringify(chats));
        localStorage.removeItem('currentChatId');
        loadChatHistory();
      }
      
      imagePreviewContainer.classList.add('hidden');
    });

    // 2. CORRECCIÓN DEL BOTÓN DE TEMA
    themeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('light-theme');
      document.body.classList.toggle('dark-theme', !isDark);
      
      // Cambiar icono según el tema
      if (document.body.classList.contains('dark-theme')) {
        themePath.setAttribute('d', 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z');
      } else {
        themePath.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
      }
    });

    userInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        sendMessage();
      }
    });

    // Inicialización
    loadChatHistory();
    userInput.focus();
  </script>
</body>
</html>
